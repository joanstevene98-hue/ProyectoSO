<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Mini-Kernel - Interfaz Gr√°fica Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .panel-full {
            grid-column: 1 / -1;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .panel h3 {
            color: #764ba2;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #17a2b8;
        }

        button.secondary:hover {
            background: #138496;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        .process-queue {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            min-height: 80px;
        }

        .process-item {
            background: white;
            border-left: 4px solid #667eea;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .process-item.running {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .process-item.blocked {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .process-item.terminated {
            border-left-color: #6c757d;
            background: #e2e3e5;
        }

        .process-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-right: 10px;
        }

        .memory-block {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin: 2px;
            border: 1px solid #333;
            border-radius: 2px;
            vertical-align: top;
        }

        .memory-free {
            background: #e9ecef;
        }

        .memory-allocated {
            background: #667eea;
        }

        .memory-dump {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            line-height: 2;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 2px;
            border: 1px solid #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .file-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item.open {
            background: #d4edda;
            border-color: #28a745;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-badge.ready {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.running {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.blocked {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.terminated {
            background: #e2e3e5;
            color: #383d41;
        }

        .io-queue {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            min-height: 60px;
        }

        .io-request {
            background: white;
            border-left: 4px solid #17a2b8;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            background: transparent;
            color: #666;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .console-line {
            margin: 3px 0;
        }

        .footer {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: #666;
            margin-top: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ•Ô∏è Simulador de Mini-Kernel</h1>
            <p>Interfaz Gr√°fica Completa - Gesti√≥n de Procesos, Memoria, Archivos y E/S</p>
        </header>

        <div class="dashboard">
            <!-- ========== PANEL: GESTI√ìN DE PROCESOS ========== -->
            <div class="panel">
                <h2>‚öôÔ∏è Gesti√≥n de Procesos (CPU Scheduling)</h2>
                
                <div class="control-group">
                    <label>Nombre del Proceso:</label>
                    <input type="text" id="processName" placeholder="P1, P2, etc." value="P1">
                </div>

                <div class="control-group">
                    <label>Tiempo de R√°faga (burst time):</label>
                    <input type="number" id="burstTime" min="1" max="50" value="10">
                </div>

                <div class="control-group">
                    <label>Planificador:</label>
                    <select id="schedulerType">
                        <option value="fifo">FIFO (First In First Out)</option>
                        <option value="rr">Round Robin (Quantum=3)</option>
                    </select>
                </div>

                <button onclick="addProcess()">‚ûï Crear Proceso</button>
                <button class="secondary" onclick="executeProcesses()">‚ñ∂Ô∏è Ejecutar Cola</button>
                <button class="danger" onclick="clearProcesses()">üóëÔ∏è Limpiar Cola</button>

                <h3>Cola de Procesos (Ready Queue)</h3>
                <div class="process-queue" id="readyQueue">
                    <p style="color: #999; text-align: center;">Vac√≠o</p>
                </div>

                <h3>Proceso en Ejecuci√≥n (Running)</h3>
                <div class="process-queue" id="runningProcess">
                    <p style="color: #999; text-align: center;">Ninguno</p>
                </div>

                <h3>Procesos Finalizados (Terminated)</h3>
                <div class="process-queue" id="terminatedQueue">
                    <p style="color: #999; text-align: center;">Vac√≠o</p>
                </div>

                <h3>Estad√≠sticas de CPU</h3>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalProcesses">0</div>
                        <div class="stat-label">Total Procesos</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="contextSwitches">0</div>
                        <div class="stat-label">Context Switches</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgTurnaround">0</div>
                        <div class="stat-label">Turnaround Avg</div>
                    </div>
                </div>

                <h3>Tabla de Procesos (PCB)</h3>
                <table id="processTable">
                    <thead>
                        <tr>
                            <th>PID</th>
                            <th>Nombre</th>
                            <th>R√°faga</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody">
                    </tbody>
                </table>
            </div>

            <!-- ========== PANEL: GESTI√ìN DE MEMORIA ========== -->
            <div class="panel">
                <h2>üíæ Gesti√≥n de Memoria (First-Fit)</h2>

                <div class="control-group">
                    <label>Tama√±o de Asignaci√≥n (bytes):</label>
                    <input type="number" id="memorySize" min="1" max="32" value="8">
                </div>

                <div class="control-group">
                    <label>PID a Asignar:</label>
                    <input type="number" id="memoryPID" min="1" value="1">
                </div>

                <button onclick="allocateMemory()">‚ûï Asignar Memoria</button>
                <button class="danger" onclick="freeMemoryByPID()">üîì Liberar por PID</button>
                <button class="secondary" onclick="visualizeMemory()">üëÅÔ∏è Visualizar Memoria</button>
                <button class="secondary" onclick="defragmentMemory()">üîÑ Compactar</button>

                <h3>Estado de Memoria</h3>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="usedMemory">0</div>
                        <div class="stat-label">Bytes Usados</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="freeMemory">64</div>
                        <div class="stat-label">Bytes Libres</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="fragmentation">0%</div>
                        <div class="stat-label">Fragmentaci√≥n</div>
                    </div>
                </div>

                <h3>Visualizaci√≥n de Heap</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color memory-free"></div>
                        <span>Libre</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color memory-allocated"></div>
                        <span>Asignado</span>
                    </div>
                </div>
                <div class="memory-dump" id="memoryVisualization"></div>

                <h3>Tabla de Asignaciones</h3>
                <table id="memoryTable">
                    <thead>
                        <tr>
                            <th>Bloque</th>
                            <th>Inicio</th>
                            <th>Tama√±o</th>
                            <th>PID</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="memoryTableBody">
                    </tbody>
                </table>
            </div>

            <!-- ========== PANEL: GESTI√ìN DE ARCHIVOS ========== -->
            <div class="panel">
                <h2>üìÅ Sistema de Archivos & E/S</h2>

                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab(event, 'files')">Archivos</button>
                    <button class="tab-button" onclick="switchTab(event, 'io')">E/S</button>
                </div>

                <!-- TAB: ARCHIVOS -->
                <div id="files" class="tab-content active">
                    <h3>Crear Archivo</h3>
                    <div class="control-group">
                        <label>Nombre del Archivo:</label>
                        <input type="text" id="fileName" placeholder="archivo.txt" value="file1.txt">
                    </div>

                    <div class="control-group">
                        <label>Tama√±o (bloques):</label>
                        <input type="number" id="fileSize" min="1" max="10" value="5">
                    </div>

                    <button onclick="createFile()">üìù Crear Archivo</button>
                    <button class="danger" onclick="deleteSelectedFile()">üóëÔ∏è Eliminar</button>
                    <button class="secondary" onclick="listFiles()">üìã Listar Archivos</button>

                    <h3>Archivos en Disco</h3>
                    <div id="filesList"></div>

                    <h3>Estad√≠sticas del FS</h3>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="totalFiles">0</div>
                            <div class="stat-label">Archivos</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="diskUsed">0</div>
                            <div class="stat-label">Bloques Usados</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="diskFree">100</div>
                            <div class="stat-label">Bloques Libres</div>
                        </div>
                    </div>
                </div>

                <!-- TAB: E/S -->
                <div id="io" class="tab-content">
                    <h3>Solicitud de E/S</h3>
                    <div class="control-group">
                        <label>Dispositivo:</label>
                        <select id="ioDevice">
                            <option value="disk">üíæ Disco</option>
                            <option value="network">üåê Red</option>
                            <option value="printer">üñ®Ô∏è Impresora</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Tipo de Operaci√≥n:</label>
                        <select id="ioOperation">
                            <option value="read">Lectura</option>
                            <option value="write">Escritura</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>PID del Proceso:</label>
                        <input type="number" id="ioPID" min="1" value="1">
                    </div>

                    <div class="control-group">
                        <label>Datos (bytes):</label>
                        <input type="number" id="ioDataSize" min="1" max="1024" value="256">
                    </div>

                    <button onclick="requestIO()">üì§ Enviar Solicitud</button>
                    <button class="secondary" onclick="pollIO()">‚è±Ô∏è Procesar (Poll)</button>
                    <button class="danger" onclick="clearIOQueue()">üóëÔ∏è Limpiar Cola</button>

                    <h3>Cola de E/S Pendientes</h3>
                    <div class="io-queue" id="ioQueue">
                        <p style="color: #999; text-align: center;">Vac√≠o</p>
                    </div>

                    <h3>Estad√≠sticas de E/S</h3>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="pendingIO">0</div>
                            <div class="stat-label">E/S Pendientes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="completedIO">0</div>
                            <div class="stat-label">E/S Completadas</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="avgIOTime">0ms</div>
                            <div class="stat-label">Tiempo Promedio</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== PANEL: CONSOLA DE EJECUCI√ìN ========== -->
            <div class="panel panel-full">
                <h2>üìü Consola de Ejecuci√≥n</h2>
                <div class="console" id="console">
                    <div class="console-line"><span style="color: #00ff00;">>>> Sistema inicializado</span></div>
                    <div class="console-line"><span style="color: #00ff00;">>>> Esperando comandos...</span></div>
                </div>
                <button class="danger" onclick="clearConsole()" style="margin-top: 10px;">üóëÔ∏è Limpiar Consola</button>
            </div>

            <!-- ========== PANEL: SIMULACI√ìN INTEGRADA ========== -->
            <div class="panel panel-full">
                <h2>üîó Simulaci√≥n Integrada</h2>
                <p style="margin-bottom: 10px;">Ejecuta un escenario que demuestra la integraci√≥n de todos los subsistemas:</p>
                
                <button onclick="runScenario1()">Escenario 1: CPU + Memoria</button>
                <button onclick="runScenario2()">Escenario 2: I/O Concurrente</button>
                <button onclick="runScenario3()">Escenario 3: Integraci√≥n Completa</button>
                <button class="danger" onclick="resetSimulation()">üîÑ Resetear Simulaci√≥n</button>

                <h3 style="margin-top: 20px;">Descripci√≥n de Escenarios</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; line-height: 1.8;">
                    <p><strong>Escenario 1 (CPU + Memoria):</strong> 4 procesos compiten por CPU y memoria. Demuestra c√≥mo una asignaci√≥n de memoria afecta el scheduling.</p>
                    <p style="margin-top: 10px;"><strong>Escenario 2 (I/O Concurrente):</strong> Procesos acceden simult√°neamente a archivos. Demuestra bloqueos de E/S y colas FIFO.</p>
                    <p style="margin-top: 10px;"><strong>Escenario 3 (Integraci√≥n Completa):</strong> Todo junto: Scheduling ‚Üí Memoria ‚Üí Archivos ‚Üí E/S en un flujo integrado.</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üéì Simulador Educativo de Mini-Kernel | Arquitectura Hexagonal | C++17 + Web Interface</p>
            <p>Universidad Distrital Francisco Jos√© de Caldas | Ingenier√≠a de Sistemas</p>
        </div>
    </div>

    <script>
        // ========== DATOS GLOBALES ==========
        let processes = [];
        let memory = new Array(64).fill(-1);
        let files = [];
        let ioQueue = [];
        let statistics = {
            contextSwitches: 0,
            completedProcesses: 0,
            totalProcesses: 0,
            completedIO: 0,
            ioTimes: []
        };

        const CONSOLE_MAX_LINES = 50;
        const MAX_FILES = 100;
        const TOTAL_DISK = 100;

        // ========== UTILIDADES DE CONSOLA ==========
        function log(message, type = 'info') {
            const console_elem = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ff00',
                'error': '#ff0000',
                'warning': '#ffff00',
                'success': '#00ff00'
            };
            const color = colors[type] || colors['info'];
            const line = document.createElement('div');
            line.className = 'console-line';
            line.innerHTML = `<span style="color: ${color};">[${timestamp}] ${message}</span>`;
            console_elem.appendChild(line);
            
            // Limitar l√≠neas
            const lines = console_elem.querySelectorAll('.console-line');
            if (lines.length > CONSOLE_MAX_LINES) {
                lines[0].remove();
            }
            console_elem.scrollTop = console_elem.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            log('Consola limpiada');
        }

        // ========== GESTI√ìN DE PROCESOS ==========
        function addProcess() {
            const name = document.getElementById('processName').value;
            const burst = parseInt(document.getElementById('burstTime').value);
            
            if (!name || burst <= 0) {
                log('‚ùå Nombre o tiempo de r√°faga inv√°lido', 'error');
                return;
            }

            const pid = processes.length + 1;
            const process = {
                pid: pid,
                name: name,
                burstTime: burst,
                remainingTime: burst,
                state: 'NEW',
                arrivalTime: new Date().getTime(),
                completionTime: null,
                scheduler: document.getElementById('schedulerType').value
            };

            processes.push(process);
            statistics.totalProcesses++;
            log(`‚úÖ Proceso creado: ${name} (PID: ${pid}, Burst: ${burst})`);
            
            updateProcessUI();
            document.getElementById('processName').value = '';
        }

        function executeProcesses() {
            if (processes.length === 0) {
                log('‚ùå No hay procesos en la cola', 'error');
                return;
            }

            const scheduler = document.getElementById('schedulerType').value;
            log(`‚ñ∂Ô∏è Ejecutando procesos con ${scheduler.toUpperCase()}`);

            let time = 0;
            const processCopy = JSON.parse(JSON.stringify(processes));

            while (processCopy.some(p => p.remainingTime > 0)) {
                for (let p of processCopy) {
                    if (p.remainingTime <= 0) continue;

                    p.state = 'RUNNING';
                    const quantum = scheduler === 'rr' ? 3 : p.remainingTime;
                    const executed = Math.min(quantum, p.remainingTime);
                    
                    p.remainingTime -= executed;
                    time += executed;
                    
                    if (p.remainingTime === 0) {
                        p.state = 'TERMINATED';
                        p.completionTime = time;
                        statistics.completedProcesses++;
                        log(`‚úÖ ${p.name} terminado (Turnaround: ${time}ms)`);
                    } else {
                        p.state = 'READY';
                        statistics.contextSwitches++;
                        log(`‚è∏Ô∏è ${p.name} preemptado (Remaining: ${p.remainingTime}ms)`);
                    }
                }
            }

            processes = processCopy;
            updateProcessUI();
        }

        function clearProcesses() {
            processes = [];
            statistics.completedProcesses = 0;
            statistics.contextSwitches = 0;
            log('üóëÔ∏è Cola de procesos limpiada');
            updateProcessUI();
        }

        function updateProcessUI() {
            // Ready Queue
            const readyProcs = processes.filter(p => p.state === 'READY');
            const readyQueue = document.getElementById('readyQueue');
            if (readyProcs.length === 0) {
                readyQueue.innerHTML = '<p style="color: #999; text-align: center;">Vac√≠o</p>';
            } else {
                readyQueue.innerHTML = readyProcs.map(p => 
                    `<div class="process-item"><span class="process-badge">${p.name}</span> R√°faga: ${p.burstTime}ms</div>`
                ).join('');
            }

            // Running
            const runningProc = processes.find(p => p.state === 'RUNNING');
            const runningDiv = document.getElementById('runningProcess');
            if (runningProc) {
                runningDiv.innerHTML = `<div class="process-item running"><span class="process-badge">${runningProc.name}</span> ${runningProc.remainingTime}ms restante</div>`;
            } else {
                runningDiv.innerHTML = '<p style="color: #999; text-align: center;">Ninguno</p>';
            }

            // Terminated
            const termProcs = processes.filter(p => p.state === 'TERMINATED');
            const termDiv = document.getElementById('terminatedQueue');
            if (termProcs.length === 0) {
                termDiv.innerHTML = '<p style="color: #999; text-align: center;">Vac√≠o</p>';
            } else {
                termDiv.innerHTML = termProcs.map(p => 
                    `<div class="process-item terminated"><span class="process-badge">${p.name}</span> Completado</div>`
                ).join('');
            }

            // Estad√≠sticas
            document.getElementById('totalProcesses').textContent = statistics.totalProcesses;
            document.getElementById('contextSwitches').textContent = statistics.contextSwitches;
            const avgTurnaround = termProcs.length > 0 ? 
                Math.round(termProcs.reduce((sum, p) => sum + (p.completionTime || 0), 0) / termProcs.length) : 0;
            document.getElementById('avgTurnaround').textContent = avgTurnaround + 'ms';

            // Tabla PCB
            const tbody = document.getElementById('processTableBody');
            tbody.innerHTML = processes.map(p => `
                <tr>
                    <td>${p.pid}</td>
                    <td>${p.name}</td>
                    <td>${p.burstTime}ms</td>
                    <td><span class="status-badge ${p.state.toLowerCase()}">${p.state}</span></td>
                    <td><button onclick="removeProcess(${p.pid})" class="danger" style="padding: 5px 10px; font-size: 0.8em;">Eliminar</button></td>
                </tr>
            `).join('');
        }

        function removeProcess(pid) {
            processes = processes.filter(p => p.pid !== pid);
            log(`üóëÔ∏è Proceso ${pid} eliminado`);
            updateProcessUI();
        }

        // ========== GESTI√ìN DE MEMORIA ==========
        function allocateMemory() {
            const size = parseInt(document.getElementById('memorySize').value);
            const pid = parseInt(document.getElementById('memoryPID').value);

            if (size <= 0 || size > 64) {
                log('‚ùå Tama√±o inv√°lido (1-64)', 'error');
                return;
            }

            // First-Fit algorithm
            let allocated = false;
            for (let i = 0; i <= memory.length - size; i++) {
                if (memory.slice(i, i + size).every(cell => cell === -1)) {
                    for (let j = i; j < i + size; j++) {
                        memory[j] = pid;
                    }
                    log(`‚úÖ Asignados ${size} bytes a PID ${pid} en posici√≥n ${i}`);
                    allocated = true;
                    break;
                }
            }

            if (!allocated) {
                log(`‚ùå No hay espacio contiguo para ${size} bytes`, 'error');
            }

            updateMemoryUI();
        }

        function freeMemoryByPID() {
            const pid = parseInt(document.getElementById('memoryPID').value);
            const initialMemory = memory.filter(x => x === pid).length;
            
            for (let i = 0; i < memory.length; i++) {
                if (memory[i] === pid) {
                    memory[i] = -1;
                }
            }

            if (initialMemory > 0) {
                log(`‚úÖ Liberados ${initialMemory} bytes de PID ${pid}`);
            } else {
                log(`‚ùå PID ${pid} no tiene memoria asignada`, 'error');
            }

            updateMemoryUI();
        }

        function visualizeMemory() {
            log('üëÅÔ∏è Visualizando estado de memoria...');
            updateMemoryUI();
        }

        function defragmentMemory() {
            // Compactar memoria moviendo datos hacia el inicio
            const used = memory.filter(x => x !== -1);
            const freed = memory.filter(x => x === -1).length;
            
            memory = [...used, ...new Array(freed).fill(-1)];
            log(`‚úÖ Memoria compactada. Fragmentaci√≥n reducida.`);
            updateMemoryUI();
        }

        function updateMemoryUI() {
            // Estad√≠sticas
            const used = memory.filter(x => x !== -1).length;
            const free = memory.filter(x => x === -1).length;
            const frag = used > 0 ? Math.round((free / used) * 100) : 0;

            document.getElementById('usedMemory').textContent = used;
            document.getElementById('freeMemory').textContent = free;
            document.getElementById('fragmentation').textContent = frag + '%';

            // Visualizaci√≥n
            const viz = memory.map((cell, idx) => {
                if (cell === -1) return `.`;
                return cell;
            }).join('');
            document.getElementById('memoryVisualization').textContent = viz;

            // Tabla
            const tbody = document.getElementById('memoryTableBody');
            let blocks = [];
            let i = 0;
            while (i < memory.length) {
                const pid = memory[i];
                let start = i;
                let size = 1;
                while (i + size < memory.length && memory[i + size] === pid) {
                    size++;
                }
                blocks.push({ start, size, pid: pid === -1 ? 'Libre' : pid });
                i += size;
            }
            
            tbody.innerHTML = blocks.map((b, idx) => `
                <tr>
                    <td>${idx}</td>
                    <td>${b.start}</td>
                    <td>${b.size}</td>
                    <td>${b.pid}</td>
                    <td>${b.pid === 'Libre' ? 'üü© Libre' : 'üü¶ Asignado'}</td>
                </tr>
            `).join('');
        }

        // ========== GESTI√ìN DE ARCHIVOS ==========
        function createFile() {
            const name = document.getElementById('fileName').value;
            const size = parseInt(document.getElementById('fileSize').value);

            if (!name || size <= 0) {
                log('‚ùå Nombre o tama√±o inv√°lido', 'error');
                return;
            }

            if (files.some(f => f.name === name)) {
                log(`‚ùå Archivo ${name} ya existe`, 'error');
                return;
            }

            const diskUsed = files.reduce((sum, f) => sum + f.size, 0);
            if (diskUsed + size > TOTAL_DISK) {
                log(`‚ùå Espacio insuficiente en disco`, 'error');
                return;
            }

            const file = {
                name: name,
                size: size,
                created: new Date().toLocaleString(),
                open: false,
                handle: null
            };

            files.push(file);
            log(`‚úÖ Archivo creado: ${name} (${size} bloques)`);
            updateFileUI();
            document.getElementById('fileName').value = '';
        }

        function deleteSelectedFile() {
            const name = document.getElementById('fileName').value;
            const file = files.find(f => f.name === name);

            if (!file) {
                log(`‚ùå Archivo no encontrado`, 'error');
                return;
            }

            if (file.open) {
                log(`‚ùå No se puede eliminar archivo abierto`, 'error');
                return;
            }

            files = files.filter(f => f.name !== name);
            log(`‚úÖ Archivo eliminado: ${name}`);
            updateFileUI();
        }

        function listFiles() {
            if (files.length === 0) {
                log('üìã No hay archivos en el sistema');
            } else {
                files.forEach(f => {
                    log(`üìÑ ${f.name} - ${f.size} bloques - ${f.open ? 'ABIERTO' : 'CERRADO'}`);
                });
            }
        }

        function updateFileUI() {
            const diskUsed = files.reduce((sum, f) => sum + f.size, 0);
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('diskUsed').textContent = diskUsed;
            document.getElementById('diskFree').textContent = TOTAL_DISK - diskUsed;

            const filesList = document.getElementById('filesList');
            if (files.length === 0) {
                filesList.innerHTML = '<p style="color: #999; text-align: center;">Sin archivos</p>';
            } else {
                filesList.innerHTML = files.map(f => `
                    <div class="file-item ${f.open ? 'open' : ''}">
                        <span>üìÑ <strong>${f.name}</strong> - ${f.size} bloques</span>
                        <span class="status-badge ${f.open ? 'running' : 'ready'}">${f.open ? 'ABIERTO' : 'CERRADO'}</span>
                    </div>
                `).join('');
            }
        }

        // ========== GESTI√ìN DE E/S ==========
        function requestIO() {
            const device = document.getElementById('ioDevice').value;
            const operation = document.getElementById('ioOperation').value;
            const pid = parseInt(document.getElementById('ioPID').value);
            const dataSize = parseInt(document.getElementById('ioDataSize').value);

            const ioRequest = {
                id: ioQueue.length + 1,
                device: device,
                operation: operation,
                pid: pid,
                dataSize: dataSize,
                timestamp: new Date().getTime(),
                completed: false
            };

            ioQueue.push(ioRequest);
            log(`üì§ E/S solicitada: ${operation.toUpperCase()} en ${device} (${dataSize} bytes)`);
            updateIOUI();
        }

        function pollIO() {
            if (ioQueue.length === 0) {
                log('‚ùå No hay solicitudes de E/S pendientes', 'error');
                return;
            }

            const request = ioQueue.shift();
            const latency = Math.random() * 100 + 50; // 50-150ms
            request.completed = true;
            statistics.completedIO++;
            statistics.ioTimes.push(latency);

            const avgTime = Math.round(statistics.ioTimes.reduce((a, b) => a + b, 0) / statistics.ioTimes.length);
            log(`‚úÖ E/S completada: ${request.operation.toUpperCase()} en ${request.device} (Latencia: ${latency.toFixed(0)}ms)`);

            updateIOUI();
            document.getElementById('avgIOTime').textContent = avgTime + 'ms';
        }

        function clearIOQueue() {
            ioQueue = [];
            log('üóëÔ∏è Cola de E/S limpiada');
            updateIOUI();
        }

        function updateIOUI() {
            document.getElementById('pendingIO').textContent = ioQueue.length;
            document.getElementById('completedIO').textContent = statistics.completedIO;

            const queue = document.getElementById('ioQueue');
            if (ioQueue.length === 0) {
                queue.innerHTML = '<p style="color: #999; text-align: center;">Vac√≠o</p>';
            } else {
                queue.innerHTML = ioQueue.map((req, idx) => `
                    <div class="io-request">
                        #${req.id} | ${req.operation.toUpperCase()} en ${req.device} | PID: ${req.pid} | ${req.dataSize}B
                    </div>
                `).join('');
            }
        }

        // ========== TABS ==========
        function switchTab(event, tabName) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            const buttons = event.target.parentElement.querySelectorAll('.tab-button');
            buttons.forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ========== ESCENARIOS INTEGRADOS ==========
        function runScenario1() {
            log('üé¨ Iniciando Escenario 1: CPU + Memoria');
            clearProcesses();
            memory.fill(-1);
            updateMemoryUI();

            // Crear procesos
            document.getElementById('processName').value = 'P1';
            document.getElementById('burstTime').value = '15';
            addProcess();
            document.getElementById('processName').value = 'P2';
            document.getElementById('burstTime').value = '10';
            addProcess();
            document.getElementById('processName').value = 'P3';
            document.getElementById('burstTime').value = '20';
            addProcess();

            // Asignar memoria
            document.getElementById('memorySize').value = '10';
            document.getElementById('memoryPID').value = '1';
            allocateMemory();
            document.getElementById('memorySize').value = '8';
            document.getElementById('memoryPID').value = '2';
            allocateMemory();

            // Ejecutar
            setTimeout(() => {
                executeProcesses();
                log('‚úÖ Escenario 1 completado');
            }, 500);
        }

        function runScenario2() {
            log('üé¨ Iniciando Escenario 2: I/O Concurrente');
            ioQueue = [];
            files = [];
            updateFileUI();

            // Crear archivos
            document.getElementById('fileName').value = 'datos1.txt';
            document.getElementById('fileSize').value = '10';
            createFile();
            document.getElementById('fileName').value = 'datos2.txt';
            document.getElementById('fileSize').value = '15';
            createFile();

            // Solicitudes de E/S
            document.getElementById('ioDevice').value = 'disk';
            document.getElementById('ioOperation').value = 'read';
            document.getElementById('ioPID').value = '1';
            requestIO();
            document.getElementById('ioOperation').value = 'write';
            document.getElementById('ioPID').value = '2';
            requestIO();

            log('‚úÖ Escenario 2: E/S pendientes generadas');
        }

        function runScenario3() {
            log('üé¨ Iniciando Escenario 3: Integraci√≥n Completa');
            runScenario1();
            setTimeout(() => {
                runScenario2();
                log('‚úÖ Escenario 3: Todos los subsistemas integrados');
            }, 1000);
        }

        function resetSimulation() {
            processes = [];
            memory.fill(-1);
            files = [];
            ioQueue = [];
            statistics = {
                contextSwitches: 0,
                completedProcesses: 0,
                totalProcesses: 0,
                completedIO: 0,
                ioTimes: []
            };

            updateProcessUI();
            updateMemoryUI();
            updateFileUI();
            updateIOUI();

            log('üîÑ Simulaci√≥n reiniciada');
        }

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', () => {
            updateProcessUI();
            updateMemoryUI();
            updateFileUI();
            updateIOUI();
            log('‚úÖ Interfaz de Simulador cargada correctamente');
        });
    </script>
</body>
</html>
